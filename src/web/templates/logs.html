<!DOCTYPE html>
<html>

<head>
  <title>Arcadia Innovations</title>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.7/dist/tailwind.min.css" rel="stylesheet">
</head>

<body>
  <div id="root"></div>

  <!-- Include React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.production.min.js"></script>

  <!-- Include Babel and JSX Transformer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.16.7/babel.min.js"></script>

  <script type="text/babel">
    var colorMapping = {
      'GENERAL': 'white',
      'PLAN': 'green',
      'MOVE': 'cyan',
      'REACT': 'gold',
      'ACT': 'blue',
      'MESSAGE': 'lightblue',
      'REFLECT': 'magenta',
      'MEMORY': 'red',
      'THOUGHT': 'gray',
      'ERROR': 'red',
      'ANNOUNCEMENT': 'lightmagenta'
    };

    function LogViewer() {
        const [logs, setLogs] = React.useState({});

        React.useEffect(() => {
          const fetchLogs = async () => {
            const response = await fetch('/logs');
            if (response.ok) {
              const data = await response.json();
              setLogs(data);
            }
          };

          fetchLogs();
          const eventSource = new EventSource('/logs');

          eventSource.onmessage = (e) => {
            const matches = e.data.match(/^\[(.*?)\] \[(.*?)\] \[(.*?)\] (.*)$/);
            if (!matches) return;

            const agentName = matches[1].trim();
            const color = matches[2].trim().split('.')[1];
            const title = matches[3].trim();
            const description = matches[4].trim();

            setLogs((prevLogs) => {
              const updatedLogs = { ...prevLogs };
              if (!updatedLogs[agentName]) {
                updatedLogs[agentName] = [];
              }

              updatedLogs[agentName] = [{ agentName, color, title, description }, ...updatedLogs[agentName]];
              return updatedLogs;
            });
          };

          return () => {
            eventSource.close();
          };
        }, []);

        const totalAgents = Object.keys(logs).length;

        return (
          <div className="h-screen flex overflow-hidden">
            <div style={{ display: 'flex' }} className="h-full">
              {Object.entries(logs).map(([agentName, logLines]) => (
                <LogWindow
                  key={agentName}
                  agentName={agentName}
                  logLines={logLines}
                  columnWidth={`${100 / totalAgents}%`}
                />
              ))}
            </div>
          </div>
        );
      }

      function LogLine({ log }) {
        const { agentName, color, title, description } = log;

        return (
          <div className="mb-4 font-mono">
            <span style={{ color: colorMapping[color], fontWeight: 'bold' }}>{title}</span>{" "}
            <TypeWriter text={description} />
          </div>
        );
      }

    function LogWindow({ agentName, logLines, columnWidth }) {
      return (
        <div style={{ width: columnWidth }} className="border border-gray-300 rounded m-2 p-2 h-full overflow-auto">
          <h2 className="text-xl font-bold mb-4">üßç {agentName}</h2>
          <div className="h-full overflow-auto">
            {logLines.map((log, index) => (
              <LogLine key={index} log={log} />
            ))}
          </div>
        </div>
      );
    }

      function TypeWriter({ text }) {
          const [currentIndex, setCurrentIndex] = React.useState(0);

          React.useEffect(() => {
            const intervalId = setInterval(() => {
              setCurrentIndex((prevIndex) => prevIndex + 1);
            }, 10);

            return () => {
              clearInterval(intervalId);
            };
          }, []);

          return <span>{text.substring(0, currentIndex)}</span>;
        }

      

      ReactDOM.render(<LogViewer />, document.getElementById('root'));
  </script>
</body>

</html>