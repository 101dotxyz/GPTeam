<!DOCTYPE html>
<html>

<head>
  <title>Arcadia Innovations</title>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.7/dist/tailwind.min.css" rel="stylesheet">
</head>

<body>
  <div id="root"></div>

  <!-- Include React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.production.min.js"></script>

  <!-- Include Babel and JSX Transformer -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>

  <script type="text/babel">
    var colorMapping = {
      'GENERAL': 'white',
      'ERROR': 'red',
      'ANNOUNCEMENT': 'lightmagenta',
      'CLI_INPUT': 'lightblack',
      'AGENT_0': 'lightcyan',
      'AGENT_1': 'yellow',
      'AGENT_2': 'blue',
      'AGENT_3': 'magenta',
      'AGENT_4': 'red',
      'AGENT_5': 'green',
      'AGENT_6': 'cyan',
      'AGENT_7': 'lightyellow',
      'AGENT_8': 'lightblue',
      'AGENT_9': 'lightgreen'
    };


    function LogViewer() {
      const [logs, setLogs] = React.useState({});
      const [worldState, setWorldState] = React.useState();

      React.useEffect(() => {
        const socket = new WebSocket('ws://' + window.location.host + '/logs');
        socket.onmessage = (e) => {

          console.log("data: ", e.data)
          const { agentName, color, title, description } = JSON.parse(e.data)



          setLogs((prevLogs) => {
            const updatedLogs = { ...prevLogs };
            if (!updatedLogs[agentName]) {
              updatedLogs[agentName] = [];
            }

            updatedLogs[agentName] = [{ agentName, color, title, description }, ...updatedLogs[agentName]];
            return updatedLogs;
          });
        };

        return () => {
          socket.close();
        };
      }, []);

      React.useEffect(() => {
        const socket = new WebSocket('ws://' + window.location.host + '/world');

        socket.onmessage = (e) => {
          const data = JSON.parse(e.data);
          setWorldState(data);
        };

        return () => {
          socket.close();
        };
      }, []);


      if (!worldState) {
        return <Loading />
      }

      return (
        <div className="min-h-screen flex overflow-hidden bg-gray-800 text-white">
          <div className="h-screen flex w-screen">
            {(worldState.agents || []).map((agent) => <AgentWindow agent={agent} logLines={logs[agent.full_name] || []} columnWidth={`${100 / worldState.agents.length}%`} />)}
          </div>
        </div>
      );
    }

    function LogLine({ log }) {
      const { agentName, color, title, description } = log;

      return (
        <div className="mb-4 font-mono">
          <span style={{ color: colorMapping[color], fontWeight: 'bold' }}>{title}</span>{" "}
          <TypeWriter text={description} />
        </div>
      );
    }

    function AgentWindow({ agent, logLines, columnWidth }) {
      return (
        <div style={{ width: columnWidth }} className="m-2 p-2 h-full overflow-auto">
          <AgentInformation agent={agent} />
          <LogWindow logLines={logLines} />
        </div>
      );
    }

    function AgentInformation({ agent }) {
      return (
        <div class="pb-4 bg-gray-800 text-white">
          <div class="flex items-center">
            <div class="w-1/2">
              <h2 class="text-lg font-bold">{agent.full_name}</h2>
              <p class="text-base">{agent.location}</p>
            </div>
            <div class="w-1/2 text-right">
              <h2 class="text-lg font-bold">Agent Status</h2>
              <p class="text-base">Online</p>
            </div>
          </div>
        </div>)
    }

    function LogWindow({ logLines }) {
      return (
        <div className="h-full overflow-auto bg-black text-white p-4">
          {logLines.map((log, index) => (
            <LogLine key={index} log={log} />
          ))}
        </div>
      );
    }

    function TypeWriter({ text }) {
      const [currentIndex, setCurrentIndex] = React.useState(0);

      React.useEffect(() => {
        const intervalId = setInterval(() => {
          setCurrentIndex((prevIndex) => prevIndex + 1);
        }, 10);

        return () => {
          clearInterval(intervalId);
        };
      }, []);

      return <span>{text.substring(0, currentIndex)}</span>;
    }

    function Loading() {
      return (
        <div className="flex items-center justify-center h-screen bg-gray-600 text-white">
          Loading...
        </div>
      );
    }


    ReactDOM.render(<LogViewer />, document.getElementById('root'));
  </script>
</body>

</html>